name: Build & Deploy billing_service (Oracle VM)

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-billing-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Build JAR
        run: |
          chmod +x ./gradlew
          ./gradlew clean test bootJar --stacktrace
          ls -la build/libs
          JAR=$(ls -1 build/libs/*.jar | head -n 1)
          cp "$JAR" app.jar

      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ORACLE_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.ORACLE_HOST }}" >> ~/.ssh/known_hosts

      - name: Prepare remote folder
        run: |
          ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} "\
            mkdir -p /home/${{ secrets.ORACLE_USER }}/app/billing_service \
          "

      - name: Upload artifacts (atomic)
        run: |
          scp app.jar ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}:/home/${{ secrets.ORACLE_USER }}/app/billing_service/app.jar.tmp
          ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} "\
            mv /home/${{ secrets.ORACLE_USER }}/app/billing_service/app.jar.tmp \
               /home/${{ secrets.ORACLE_USER }}/app/billing_service/app.jar \
          "

      - name: Deploy
        run: |
          ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} "\
            cd /home/${{ secrets.ORACLE_USER }}/app && \
            docker compose up -d --build billing-service && \
            docker compose ps \
          "

      - name: Optional HTTP healthcheck
        if: ${{ success() && vars.HEALTHCHECK_URL != '' }}
        run: |
          for i in {1..18}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.HEALTHCHECK_URL }}") || true
            if [ "$code" = "200" ]; then exit 0; fi
            sleep 5
          done
          exit 1