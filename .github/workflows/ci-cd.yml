name: Build & Deploy billing_service (Oracle VM)

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-billing-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Run Tests
        run: |
          chmod +x ./gradlew
          ./gradlew clean test --no-daemon --stacktrace

      - name: Debug test files
        if: always()
        run: |
          find . -maxdepth 6 -type d -name "test-results" -print || true
          find . -maxdepth 8 -type f -name "TEST-*.xml" -print || true
          find . -maxdepth 8 -type f -path "*/build/reports/tests/test/index.html" -print || true

      - name: Test summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          mapfile -t files < <(find . -type f -name "TEST-*.xml" 2>/dev/null || true)

          if [ ${#files[@]} -eq 0 ]; then
            echo -e "\033[33mâš ï¸  No JUnit XML found (TEST-*.xml)\033[0m"
            echo "### ðŸ§ª Test Summary" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "âš ï¸ No JUnit XML found (TEST-*.xml)." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          total=0
          failures=0
          errors=0
          skipped=0

          for f in "${files[@]}"; do
            t=$(grep -oP 'tests="\K[0-9]+'     "$f" | head -n1 || echo 0)
            fa=$(grep -oP 'failures="\K[0-9]+' "$f" | head -n1 || echo 0)
            er=$(grep -oP 'errors="\K[0-9]+'   "$f" | head -n1 || echo 0)
            sk=$(grep -oP 'skipped="\K[0-9]+'  "$f" | head -n1 || echo 0)

            total=$((total + t))
            failures=$((failures + fa))
            errors=$((errors + er))
            skipped=$((skipped + sk))
          done

          failed=$((failures + errors))
          passed=$((total - failed - skipped))
          [ $passed -lt 0 ] && passed=0

          GREEN="\033[32m"; RED="\033[31m"; YELLOW="\033[33m"; RESET="\033[0m"

          if [ $failed -eq 0 ]; then
            echo -e "${GREEN}âœ… ALL TESTS OK${RESET}"
          else
            echo -e "${RED}âŒ TESTS FAILED${RESET}"
          fi

          echo -e "${GREEN}Passed:${RESET}  $passed"
          echo -e "${RED}Failed:${RESET}  $failed  (failures=$failures, errors=$errors)"
          echo -e "${YELLOW}Skipped:${RESET} $skipped"
          echo "Total:   $total"

          echo "### ðŸ§ª Test Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ $failed -eq 0 ]; then
            echo "âœ… **ALL TESTS OK**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "âŒ **TESTS FAILED**" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Count |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---:|" >> "$GITHUB_STEP_SUMMARY"
          echo "| âœ… Passed | $passed |" >> "$GITHUB_STEP_SUMMARY"
          echo "| âŒ Failed | $failed |" >> "$GITHUB_STEP_SUMMARY"
          echo "| â†ªï¸ Skipped | $skipped |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ðŸ“¦ Total | $total |" >> "$GITHUB_STEP_SUMMARY"


      - name: Build JAR
        run: |
          chmod +x ./gradlew
          ./gradlew clean test bootJar --stacktrace
          ls -la build/libs
          JAR=$(ls -1 build/libs/*.jar | head -n 1)
          cp "$JAR" app.jar

      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ORACLE_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.ORACLE_HOST }}" >> ~/.ssh/known_hosts

      - name: Prepare remote folder
        run: |
          ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} "\
            mkdir -p /home/${{ secrets.ORACLE_USER }}/app/billing_service \
          "

      - name: Upload artifacts (atomic)
        run: |
          scp app.jar ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}:/home/${{ secrets.ORACLE_USER }}/app/billing_service/app.jar.tmp
          ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} "\
            mv /home/${{ secrets.ORACLE_USER }}/app/billing_service/app.jar.tmp \
               /home/${{ secrets.ORACLE_USER }}/app/billing_service/app.jar \
          "

      - name: Deploy
        run: |
          ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} "\
            cd /home/${{ secrets.ORACLE_USER }}/app && \
            docker compose up -d --build billing-service && \
            docker compose ps \
          "

      - name: Optional HTTP healthcheck
        if: ${{ success() && vars.HEALTHCHECK_URL != '' }}
        run: |
          for i in {1..18}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.HEALTHCHECK_URL }}") || true
            if [ "$code" = "200" ]; then exit 0; fi
            sleep 5
          done
          exit 1
